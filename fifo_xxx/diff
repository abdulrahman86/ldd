--- ../fifo_sysfs/fifo.c	2013-08-16 23:31:14.883396493 -0700
+++ fifo.c	2013-08-17 10:06:23.329527514 -0700
@@ -1,7 +1,10 @@
 #include <linux/cdev.h>
+#include <linux/delay.h>
 #include <linux/device.h>
 #include <linux/fs.h>
 #include <linux/module.h>
+#include <linux/mutex.h>
+#include <linux/sched.h>
 #include <linux/slab.h>
 #include <linux/uaccess.h>
 
@@ -33,6 +36,37 @@
 	return 0;
 }
 
+#define DEFINE_PWAIT(uid)													\
+																			\
+static DEFINE_MUTEX(in_mtx_##uid);											\
+static DEFINE_MUTEX(out_mtx_##uid);											\
+																			\
+static void pwait_##uid(void) {												\
+	static int in = 0;														\
+	static int out = 0;														\
+																			\
+	mutex_lock(&in_mtx_##uid);												\
+	if (++in >= 2) {														\
+		mutex_lock(&out_mtx_##uid);											\
+		out += 2;															\
+		mutex_unlock(&out_mtx_##uid);										\
+		in -= 2;															\
+	}																		\
+	mutex_unlock(&in_mtx_##uid);											\
+																			\
+	do {																	\
+		mutex_lock(&out_mtx_##uid);											\
+		if (out) {															\
+			out -= 1;														\
+			mutex_unlock(&out_mtx_##uid);									\
+			break;															\
+		}																	\
+		mutex_unlock(&out_mtx_##uid);										\
+	} while (1);															\
+}
+
+DEFINE_PWAIT(fifo_read);
+
 static ssize_t fifo_read(struct file *filp, char __user *buf,
 							size_t count,
 							loff_t *f_pos)
@@ -44,6 +78,7 @@
 
 	while (left) {
 
+		pwait_fifo_read();
 		if (dev->empty) {
 			break;
 		}
@@ -67,6 +102,8 @@
 	return (count - left);
 }
 
+DEFINE_PWAIT(fifo_write);
+
 static ssize_t fifo_write(struct file *filp, const char __user *buf,
 							size_t count,
 							loff_t *f_pos)
@@ -78,6 +115,8 @@
 
 	while (left) {
 
+		pwait_fifo_write();
+
 		if (!(dev->empty) && (dev->read_ptr == dev->write_ptr)) {
 			break;
 		}
